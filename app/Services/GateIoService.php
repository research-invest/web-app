<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Lin\Gate\GateFuture;

/**
 * @doc https://www.gate.io/docs/developers/apiv4/#funding-account-list
 * @doc https://github.com/zhouaini528/gate-php
 * @site test https://www.gate.io/ru/testnet/futures_trade/USDT/BTC_USDT
 */
class GateIoService
{
    private GateFuture $future;

    public function __construct(string $apiKey, string $apiSecret, bool $isTestnet = true)
    {
        $host = $isTestnet ? 'https://fx-api-testnet.gateio.ws' : 'https://api.gateio.ws';

//        Live trading: https://api.gateio.ws/api/v4
//Futures TestNet trading: https://fx-api-testnet.gateio.ws/api/v4
//Futures live trading alternative (futures only): https://fx-api.gateio.ws/api/v4

        $this->future = new GateFuture($apiKey, $apiSecret, $host);
    }

    public function getCurrentPrice(string $symbol): array
    {
        $startTime = microtime(true);

//  "funding_rate_indicative" => "0.00005"
//  "mark_price_round" => "0.1"
//  "funding_offset" => 0
//  "in_delisting" => false
//  "risk_limit_base" => "20000"
//  "interest_rate" => "0.0003"
//  "index_price" => "209.28"
//  "order_price_round" => "0.1"
//  "order_size_min" => 1
//  "ref_rebate_rate" => "0.2"
//  "name" => "TAO_USDT"
//  "ref_discount_rate" => "0"
//  "order_price_deviate" => "0.1"
//  "maintenance_rate" => "0.01"
//  "mark_type" => "index"
//  "funding_interval" => 14400
//  "type" => "direct"
//  "risk_limit_step" => "4980000"
//  "enable_bonus" => true
//  "enable_credit" => true
//  "leverage_min" => "1"
//  "funding_rate" => "0.00005"
//  "last_price" => "209.2"
//  "mark_price" => "209.2"
//  "order_size_max" => 1000000
//  "funding_next_apply" => 1743768000
//  "short_users" => 99
//  "config_change_time" => 1742203758
//  "create_time" => 1713155329
//  "trade_size" => 211328818
//  "position_size" => 518725
//  "long_users" => 347
//  "quanto_multiplier" => "0.01"
//  "funding_impact_value" => "5000"
//  "leverage_max" => "50"
//  "cross_leverage_default" => "10"
//  "risk_limit_max" => "5000000"
//  "maker_fee_rate" => "-0.0001"
//  "taker_fee_rate" => "0.00075"
//  "orders_limit" => 100
//  "trade_id" => 3585240
//  "orderbook_id" => 722991049
//  "funding_cap_ratio" => "2"
//  "voucher_leverage" => "0"
//  "is_pre_market" => false
//] // app/Services/GateIoService.php:27


        try {
            //$result = $this->future->contract()->get(['settle' => 'usdt', 'contract' => $symbol]);

            $result = $this->future->market()->getCandlesticks([
                'settle' => 'usdt',
                'contract' => $symbol,
                'interval' => '1s',
                'limit' => 1,
            ]);

            $endTime = microtime(true);

//            0 => array:7 [
//                "o" => "0.001155"
//    "v" => 0
//    "t" => 1748152369
//    "c" => "0.001155"
//    "l" => "0.001155"
//    "h" => "0.001155"
//    "sum" => "0"
//  ]

            return [
//                'price' => $result['last_price'] ?? null,
                'open' => $result[0]['o'] ?? null,
                'close' => $result[0]['c'] ?? null,
                'low' => $result[0]['l'] ?? null,
                'high' => $result[0]['h'] ?? null,
                'execution_time' => $this->calcExecutionTime($startTime, $endTime),
            ];
        } catch (\Exception $e) {
            Log::error('Failed to get current price', [
                'symbol' => $symbol,
                'error' => $e->getMessage()
            ]);
            throw $e;
        }
    }


    private function calcExecutionTime(float $startTime, float $endTime): float
    {
        $executionTime = ($endTime - $startTime) * 1000;
        return round($executionTime, 2);
    }


    /**
     * –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é
     */
    public function openPosition($contract, $side, $type = 'limit', $size = 1, $price = null, $takeProfit = null, $stopLoss = null)
    {

//        $contracts = $this->future->contract()->get([
//            'settle' => 'usdt',
//            'contract' => $contract,
//        ]);
//
//        dd($contracts);

        try {
            $params = [
                'contract' => $contract,
                'side' => $side,
                'size' => $size,
                'type' => $type,
                'tif' => 'gtc',
            ];

            if ($type === 'limit' && $price !== null) {
                $params['price'] = $price;
            }

            // –î–æ–±–∞–≤–∏–º Take Profit / Stop Loss
            $closeOrders = [];

            if ($takeProfit !== null) {
                $closeOrders[] = [
                    'price' => (string)$takeProfit,
                    'size' => $size,
                    'close' => true
                ];
            }

            if ($stopLoss !== null) {
                $closeOrders[] = [
                    'price' => (string)$stopLoss,
                    'size' => $size,
                    'close' => true
                ];
            }

            if (!empty($closeOrders)) {
                $params['close_orders'] = $closeOrders;
            }

            $result = $this->future->order()->post($params);
            echo "üü¢ –û—Ä–¥–µ—Ä —Å TP/SL –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: " . json_encode($result, JSON_THROW_ON_ERROR | JSON_PRETTY_PRINT) . PHP_EOL;
            return $result;
        } catch (\Exception $e) {
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏: " . $e->getMessage() . PHP_EOL;
            return null;
        }
    }

    /**
     * –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ç-–æ—Ä–¥–æ–º (–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–º)
     */
    public function closePosition($contract)
    {
        try {
            // –£–∑–Ω–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
            $position = $this->future->position()->get(['contract' => $contract]);
            if (empty($position) || $position['size'] == 0) {
                echo "‚ÑπÔ∏è –ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø–æ $contract" . PHP_EOL;
                return null;
            }

            $side = $position['size'] > 0 ? 'sell' : 'buy';

            $result = $this->future->order()->post([
                'contract' => $contract,
                'side' => $side,
                'size' => abs($position['size']),
                'type' => 'market',
            ]);

            echo "üî¥ –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞: " . json_encode($result, JSON_PRETTY_PRINT) . PHP_EOL;
            return $result;
        } catch (\Exception $e) {
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏: " . $e->getMessage() . PHP_EOL;
            return null;
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
     */
    public function checkBalance($currency = 'USDT')
    {
        try {
            $balances = $this->future->account()->get([
                'settle' => $currency
            ]);

            dd($balances);
            foreach ($balances as $balance) {
                if ($balance['currency'] === strtoupper($currency)) {
                    echo "üí∞ –ë–∞–ª–∞–Ω—Å {$currency}: " . $balance['available'] . PHP_EOL;
                    return $balance;
                }
            }

            echo "‚ùå –í–∞–ª—é—Ç–∞ $currency –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" . PHP_EOL;
            return null;
        } catch (\Exception $e) {
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: " . $e->getMessage() . PHP_EOL;
            return null;
        }
    }


    /**
     * –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é
     *
     * @param string $symbol –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'BTC_USDT')
     * @param float $quantity –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
     * @param string $side –°—Ç–æ—Ä–æ–Ω–∞ (BUY –∏–ª–∏ SELL)
     * @param int $leverage –ü–ª–µ—á–æ
     * @return array
     */
    public function openPosition1(string $symbol, float $quantity, string $side = 'BUY', int $leverage = 5): array
    {

        $response = $this->future->position()->postLeverage([
            'settle' => 'usdt',
            'contract' => $symbol,
            'size' => $quantity,
            'price' => 0, // 0 –¥–ª—è —Ä—ã–Ω–æ—á–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
            'tif' => 'ioc', // immediate-or-cancel –¥–ª—è —Ä—ã–Ω–æ—á–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
            'side' => $side,
        ]);

        return [
            'success' => true,
            'data' => $response,
        ];


        try {
//            $this->future->privates()->postPositionLeverage([
//                'settle' => 'usdt',
//                'contract' => $symbol,
//                'leverage' => $leverage,
//            ]);

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é

        } catch (\Exception $e) {
            return [
                'success' => false,
                'error' => $e->getMessage(),
            ];
        }
    }

    /**
     * –ó–∞–∫—Ä—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
     *
     * @param string $symbol –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞
     * @param float $quantity –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
     * @param string $side –°—Ç–æ—Ä–æ–Ω–∞ (–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–∞—è –æ—Ç–∫—Ä—ã—Ç–∏—é)
     * @return array
     */
    public function closePositio2n2(string $symbol, float $quantity, string $side): array
    {
        try {
            $response = $this->future->privates()->postOrder([
                'settle' => 'usdt',
                'contract' => $symbol,
                'size' => $quantity,
                'price' => 0, // —Ä—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä
                'tif' => 'ioc',
                'side' => $side,
                'close' => true, // —É–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —ç—Ç–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏
            ]);

            return [
                'success' => true,
                'data' => $response,
            ];
        } catch (\Exception $e) {
            return [
                'success' => false,
                'error' => $e->getMessage(),
            ];
        }
    }

    /**
     * –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
     *
     * @return array
     */
    public function closeAllPositions3(): array
    {
        try {
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
            $positions = $this->future->privates()->getPositions([
                'settle' => 'usdt',
            ]);

            $results = [];

            foreach ($positions as $position) {
                if ($position['size'] == 0) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –∑–∞–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ—Ä–æ–Ω—É –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è (–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏)
                $closeSide = $position['size'] > 0 ? 'SELL' : 'BUY';

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é
                $result = $this->closePosition(
                    $position['contract'],
                    abs($position['size']),
                    $closeSide
                );

                $results[$position['contract']] = $result;
            }

            return [
                'success' => true,
                'data' => $results,
            ];
        } catch (\Exception $e) {
            return [
                'success' => false,
                'error' => $e->getMessage(),
            ];
        }
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–∏
     *
     * @param string $symbol –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞
     * @return array
     */
    public function getPosition3(string $symbol): array
    {
        try {
            $response = $this->future->privates()->getPosition([
                'settle' => 'usdt',
                'contract' => $symbol,
            ]);

            return [
                'success' => true,
                'data' => $response,
            ];
        } catch (\Exception $e) {
            return [
                'success' => false,
                'error' => $e->getMessage(),
            ];
        }
    }


}
